# WMS（仓库管理系统）业务背景介绍

## 面向读者
本文档帮助相关人员快速理解 WMS 系统的业务背景、核心概念和业务流程。

---

## 1. 什么是 WMS

### 1.1 WMS 概念
WMS（Warehouse Management System，仓库管理系统）是用于管理仓库日常运营的软件系统。它帮助企业高效地管理库存、跟踪货物流动、优化仓储空间，确保货物准确、及时地进出仓库。

### 1.2 系统定位和作用
本 WMS 系统是一个简化版的仓库管理系统，主要服务于：
- **电商企业**：管理商品入库、库存、订单发货
- **零售企业**：管理门店配货、库存调拨
- **制造企业**：管理原材料和成品的仓储

### 1.3 核心价值
- **提高效率**：自动化处理入库、出库、盘点等流程
- **库存准确性**：实时跟踪库存变化，减少账实不符
- **防止超卖**：出库前校验库存，避免承诺无法交付的订单
- **数据追溯**：记录所有库存变动，支持审计和问题排查

---

## 2. 业务场景与角色

### 2.1 典型使用场景

#### 场景一：电商订单发货
1. 客户在电商平台下单
2. 仓库操作员在 WMS 中创建出库单
3. 拣货员根据出库单拣货，标记为"已拣货"
4. 打包发货后，确认发货，系统自动扣减库存

#### 场景二：供应商送货入库
1. 采购部门与供应商确认送货计划
2. 仓库操作员创建入库单，记录预计到货商品和数量
3. 货物到达后，验收员核对实际数量
4. 确认入库，系统自动增加库存

#### 场景三：多仓库调拨
1. A 仓库某商品库存不足，B 仓库有富余
2. 仓库管理员创建调拨单，从 B 仓调拨到 A 仓
3. 系统原子性地完成：B 仓扣减库存，A 仓增加库存

### 2.2 用户角色

#### 管理员（Admin）
- **权限**：访问所有功能，包括用户管理、仓库配置、系统设置
- **典型操作**：创建用户、分配仓库权限、查看全局报表

#### 仓库操作员（Warehouse Operator）
- **权限**：只能操作被授权的仓库数据（数据隔离）
- **典型操作**：
  - 商品管理：新增、编辑、查询商品
  - 入库管理：创建入库单、确认入库
  - 出库管理：创建出库单、拣货、发货
  - 库存管理：查询库存、库存调拨、库存盘点

### 2.3 权限模型
- **认证要求**：所有业务接口必须登录后访问
- **数据隔离**：普通操作员只能看到和操作被授权仓库的数据
- **接口访问控制**：管理员接口（如用户管理）普通用户无法访问

---

## 3. 核心业务概念

### 3.1 商品（Product）
商品是仓库管理的基本单位。

**核心属性**：
- **SKU（Stock Keeping Unit）**：库存单位，全局唯一标识符，例如 `PROD-001`
- **名称**：商品名称，例如 `iPhone 15 Pro 256GB 黑色`
- **规格**：商品规格描述，例如 `256GB/黑色`
- **单位**：计量单位，例如 `台`、`箱`、`件`
- **分类**：商品分类，例如 `电子产品`、`食品`

**业务规则**：
- SKU 必须全局唯一（不同商品不能使用相同 SKU）
- 有库存的商品不允许删除

### 3.2 仓库（Warehouse）
仓库是物理存储空间的抽象。

**典型示例**：
- 北京仓
- 上海仓
- 广州仓

**业务特点**：
- 支持多仓库管理
- 不同仓库的库存独立核算
- 可以在仓库间进行库存调拨

### 3.3 库位（Location）
库位是仓库内的具体存储位置，用于精细化管理货物存放。

**命名示例**：
- `A-01-01`：A 区 01 排 01 号
- `B-02-05`：B 区 02 排 05 号

**作用**：
- 方便拣货员快速找到货物
- 优化仓库空间利用率

### 3.4 库存（Inventory）
库存记录了每个仓库中每个商品的数量和状态。

**核心字段**：
- **可用库存（available_qty）**：可以用于销售、调拨的数量
- **锁定库存（locked_qty）**：已被出库单占用，但尚未发货的数量
- **预警阈值（warning_threshold）**：库存低于此值时需要预警

**库存状态变化示例**：
```
初始：可用库存 100，锁定库存 0
创建出库单（数量 30）：可用库存 70，锁定库存 30
发货确认：可用库存 70，锁定库存 0
```

### 3.5 入库单（Inbound Order）
入库单用于记录货物入库的业务单据。

**应用场景**：
- 采购入库：供应商送货
- 退货入库：客户退货回仓

**核心信息**：
- 仓库
- 商品清单（商品 + 数量 + 单价）
- 状态（见下文状态机）
- 创建人、创建时间、确认时间

### 3.6 出库单（Outbound Order）
出库单用于记录货物出库的业务单据。

**应用场景**：
- 销售出库：发货给客户
- 调拨出库：转移到其他仓库

**核心信息**：
- 仓库
- 商品清单（商品 + 数量）
- 状态（见下文状态机）
- 创建人、创建时间、拣货时间、发货时间

---

## 4. 业务流程详解

### 4.1 商品管理流程

#### 基本流程
```
商品创建 → 商品维护（编辑） → 商品查询 → （可选）商品删除
```

#### 关键业务规则
1. **SKU 唯一性**：创建商品时，系统校验 SKU 是否已存在，重复则返回错误（`SKU_DUPLICATED`）
2. **删除限制**：有库存的商品不允许删除，防止数据不一致（返回 `PRODUCT_HAS_STOCK`）
3. **字段校验**：
   - SKU：1-32 字符，建议格式 `^[A-Z0-9-]+$`
   - 名称：1-100 字符
   - 图片：仅支持 jpg/png/gif，大小 ≤ 5MB

#### 测试关注点
- 新增重复 SKU 是否正确拦截
- 有库存商品删除是否正确拦截
- 编辑商品后列表是否立即刷新

---

### 4.2 入库业务流程

#### 状态机流转
```
DRAFT（草稿） → PENDING（待入库） → CONFIRMED（已入库）
                                 ↓
                            CANCELED（已取消）
```

#### 详细流程
1. **创建入库单（DRAFT → PENDING）**
   - 操作员选择仓库
   - 添加商品行：选择商品、输入数量和单价
   - 系统自动计算总数量和总金额（保留 2 位小数）
   
2. **确认入库（PENDING → CONFIRMED）**
   - 货物验收完成后，操作员点击"确认入库"
   - 系统执行：
     - 将入库单状态更新为 `CONFIRMED`
     - 增加对应仓库的商品库存
     - 记录确认时间和操作人
     - 写入审计日志

3. **取消入库（DRAFT → CANCELED）**
   - 仅草稿状态可以取消
   - 已确认的入库单不可取消

#### 关键业务规则
- **数量校验**：入库数量必须为正整数（> 0）
- **不可逆操作**：`CONFIRMED` 状态的入库单不可修改、不可删除、不可再次确认
- **金额计算**：总金额 = Σ(数量 × 单价)，保留 2 位小数

#### 测试关注点
- 已入库单据再次确认是否返回 `INBOUND_STATUS_CONFLICT`
- 已入库单据修改是否被拦截
- 确认入库后库存是否正确增加
- 商品行删除/修改后总数量和总金额是否自动重算

---

### 4.3 出库业务流程

#### 状态机流转
```
DRAFT（草稿） → PENDING_PICK（待拣货） → PICKED（已拣货） → SHIPPED（已发货）
                                                          ↓
                                                     CANCELED（已取消）
```

#### 详细流程
1. **创建出库单（DRAFT → PENDING_PICK）**
   - 操作员选择仓库
   - 添加商品行：选择商品、输入数量
   - 系统校验：库存是否充足（防止超卖）
   
2. **拣货确认（PENDING_PICK → PICKED）**
   - 拣货员根据出库单拣选货物
   - 完成后点击"拣货确认"
   - 系统记录拣货时间

3. **发货确认（PICKED → SHIPPED）**
   - 货物打包完成，准备发出
   - 操作员点击"发货确认"
   - 系统执行：
     - 将出库单状态更新为 `SHIPPED`
     - 扣减对应仓库的商品库存（可用库存 - 数量）
     - 记录发货时间和操作人
     - 写入审计日志

#### 关键业务规则
- **库存校验**：
  - 创建出库单时，校验库存是否充足
  - 发货确认时，再次校验库存（防止并发超卖）
  - 库存不足返回 `INSUFFICIENT_STOCK`
- **不可逆操作**：`SHIPPED` 状态不可回退，不可修改数量
- **原子性**：发货失败时需要回滚库存

#### 测试关注点
- 库存不足时创建/发货是否被正确拦截
- 发货后库存是否正确扣减
- 状态流转是否符合状态机规则（例如：SHIPPED 是否可以回退到 PICKED）
- 并发场景下是否会超卖

---

### 4.4 库存管理流程

#### 4.4.1 库存查询和预警
- **库存列表**：按仓库、商品筛选，显示可用库存、锁定库存
- **库存预警**：显示库存低于预警阈值的商品（包括库存为 0 的情况）
- **阈值修改**：管理员可以修改预警阈值，修改后立即生效

#### 4.4.2 库存调拨
库存调拨用于在不同仓库间转移库存。

**业务流程**：
```
选择商品 → 选择源仓库和目标仓库 → 输入调拨数量 → 确认调拨
```

**系统执行**：
1. 校验源仓库库存是否充足
2. 原子性执行：
   - 源仓库：可用库存 - 数量
   - 目标仓库：可用库存 + 数量
3. 记录审计日志

**关键业务规则**：
- **库存充足校验**：源仓库可用库存必须 ≥ 调拨数量
- **原子性**：源仓扣减与目标仓增加必须同时成功或同时失败
- **不允许负库存**：任何操作不得导致库存为负数

#### 4.4.3 库存盘点
库存盘点用于核对账面库存与实际库存是否一致。

**业务流程**：
```
创建盘点单 → 实地盘点 → 录入实盘数量 → 提交盘点 → 系统调整库存
```

**系统执行**：
1. 操作员创建盘点单，系统记录当前账面库存
2. 操作员录入实盘数量
3. 提交盘点后，系统计算差异：
   - 盘盈：实盘 > 账面，增加库存
   - 盘亏：实盘 < 账面，减少库存
4. 记录审计日志

**关键业务规则**：
- **单次提交**：盘点单只能提交一次，不可重复提交（返回 `STOCKTAKE_ALREADY_SUBMITTED`）
- **差异处理**：系统自动调整库存以匹配实盘数量

#### 测试关注点
- 调拨时源仓库存不足是否返回 `INSUFFICIENT_STOCK`
- 调拨是否保证原子性（不会出现源仓扣减了但目标仓没增加）
- 盘点重复提交是否被拦截
- 盘点后库存是否正确调整

---

## 5. 系统架构概览

### 5.1 架构模式
本系统采用**前后端分离架构**：
- **前端**：负责用户交互和界面展示
- **后端**：负责业务逻辑处理和数据存储
- **通信方式**：前端通过 RESTful API 调用后端服务

### 5.2 技术栈

#### 后端
- **框架**：FastAPI（Python Web 框架）
- **ORM**：SQLAlchemy（对象关系映射，简化数据库操作）
- **数据库**：SQLite（开发环境，轻量级文件数据库）
- **认证**：JWT（JSON Web Token，无状态认证）

#### 前端
- **构建工具**：Vite（快速的前端构建工具）
- **框架**：React（用户界面库）
- **语言**：TypeScript

### 5.3 API 设计
系统采用 **RESTful** 风格设计 API：
- **GET**：查询资源（列表、详情）
- **POST**：创建资源
- **PUT**：更新资源、状态变更（如确认入库）
- **DELETE**：删除资源

**统一响应结构**：
```json
{
  "code": "OK",
  "message": "ok",
  "data": {}
}
```

**常见错误码**：
- `400 BAD_REQUEST`：请求参数错误
- `401 UNAUTHORIZED`：未登录
- `403 FORBIDDEN`：无权限
- `404 NOT_FOUND`：资源不存在
- `409 CONFLICT`：业务冲突（库存不足、SKU 重复、状态冲突等）
- `422 VALIDATION_ERROR`：字段校验失败

### 5.4 时间格式
所有接口返回的时间字段统一格式：`YYYY-MM-DD HH:mm:ss`

例如：`2025-12-31 15:30:00`

---

## 6. 数据模型关系

### 6.1 核心表关系

#### User（用户表）
- **关联**：创建入库单、出库单
- **关键字段**：username、role（admin/operator）、warehouse_ids（授权仓库列表）

#### Warehouse（仓库表）
- **关联**：
  - 一个仓库有多个库位（Location）
  - 一个仓库有多个库存记录（Inventory）
  - 一个仓库有多个入库单（InboundOrder）
  - 一个仓库有多个出库单（OutboundOrder）
- **关键字段**：name

#### Product（商品表）
- **关联**：
  - 一个商品在多个仓库有库存记录（Inventory）
  - 一个商品可以出现在多个入库单明细（InboundOrderItem）
  - 一个商品可以出现在多个出库单明细（OutboundOrderItem）
- **关键字段**：sku（唯一）、name、category

#### Inventory（库存表）
- **关联**：关联 Warehouse 和 Product
- **关键字段**：warehouse_id、product_id、available_qty、locked_qty、warning_threshold
- **说明**：一条记录表示"某个仓库中某个商品的库存"

#### InboundOrder（入库单表）
- **关联**：
  - 关联 Warehouse（入库到哪个仓库）
  - 关联 User（创建人）
  - 有多个入库单明细（InboundOrderItem）
- **关键字段**：warehouse_id、status、created_at、confirmed_at

#### InboundOrderItem（入库单明细表）
- **关联**：关联 InboundOrder 和 Product
- **关键字段**：inbound_order_id、product_id、sku、quantity、unit_price

#### OutboundOrder（出库单表）
- **关联**：
  - 关联 Warehouse（从哪个仓库出库）
  - 关联 User（创建人）
  - 有多个出库单明细（OutboundOrderItem）
- **关键字段**：warehouse_id、status、created_at、picked_at、shipped_at

#### OutboundOrderItem（出库单明细表）
- **关联**：关联 OutboundOrder 和 Product
- **关键字段**：outbound_order_id、product_id、sku、quantity

### 6.2 关系图示（文字描述）
```
User (用户)
  └─> InboundOrder (创建人)
  └─> OutboundOrder (创建人)

Warehouse (仓库)
  ├─> Location (库位)
  ├─> Inventory (库存)
  ├─> InboundOrder (入库单)
  └─> OutboundOrder (出库单)

Product (商品)
  ├─> Inventory (库存)
  ├─> InboundOrderItem (入库单明细)
  └─> OutboundOrderItem (出库单明细)

InboundOrder (入库单)
  └─> InboundOrderItem (入库单明细)

OutboundOrder (出库单)
  └─> OutboundOrderItem (出库单明细)
```

---

## 7. 关键业务规则总结

### 7.1 库存规则
1. **库存不能为负数**：任何操作（出库、调拨）不得导致库存为负
2. **库存校验时机**：
   - 创建出库单时：预先校验库存
   - 发货确认时：再次校验库存（防止并发超卖）
   - 调拨时：校验源仓库库存
3. **库存变动记录**：所有库存增减必须记录审计日志（操作人、时间、类型、数量）

### 7.2 唯一性规则
1. **SKU 全局唯一**：不同商品不能使用相同 SKU
2. **用户名唯一**：系统中不能有重复的用户名

### 7.3 状态机规则
1. **单向流转**：部分状态只能向前流转，不可回退
   - 入库单：`CONFIRMED` 后不可回退
   - 出库单：`SHIPPED` 后不可回退
2. **状态锁定**：某些状态下禁止修改数据
   - 入库单 `CONFIRMED` 后不可修改、删除
   - 出库单 `SHIPPED` 后不可修改数量

### 7.4 原子性规则
1. **库存调拨**：源仓扣减与目标仓增加必须同时成功或同时失败
2. **发货确认**：状态更新和库存扣减必须同时成功或同时失败

### 7.5 权限规则
1. **登录要求**：所有业务接口必须登录后访问
2. **数据隔离**：仓库操作员只能操作被授权仓库的数据
3. **接口访问控制**：普通用户不可访问管理员接口

### 7.6 数据格式规则
1. **时间格式**：统一为 `YYYY-MM-DD HH:mm:ss`
2. **金额精度**：保留 2 位小数
3. **数量类型**：必须为正整数

---

## 8. 测试关注点

### 8.1 测试目标
**测试目标**：
1. 根据 PRD（产品需求文档）编写测试用例
2. 执行测试，发现系统中的缺陷
3. 提交缺陷报告

### 8.2 重点测试领域

#### 8.2.1 状态机流转
- **测试点**：
  - 状态是否按照规定的状态机流转
  - 非法的状态流转是否被拦截（如：SHIPPED → PICKED）
  - 已入库/已发货的单据是否可以修改或删除
- **示例用例**：
  - 尝试对已入库单据再次确认入库，预期返回 `INBOUND_STATUS_CONFLICT`
  - 尝试修改已发货的出库单，预期返回错误

#### 8.2.2 库存一致性
- **测试点**：
  - 入库确认后库存是否正确增加
  - 出库发货后库存是否正确扣减
  - 库存调拨是否保证原子性
  - 并发场景下是否会出现超卖
  - 库存是否会出现负数
- **示例用例**：
  - 创建入库单（数量 100）并确认，检查库存是否增加 100
  - 库存为 50 时，尝试创建数量为 100 的出库单，预期返回 `INSUFFICIENT_STOCK`
  - 同时创建多个出库单，总数量超过库存，检查是否会超卖

#### 8.2.3 权限控制
- **测试点**：
  - 未登录用户是否可以访问业务接口
  - 仓库操作员是否只能看到授权仓库的数据
  - 普通用户是否可以访问管理员接口
- **示例用例**：
  - 不携带 token 访问 `/api/products`，预期返回 `401 UNAUTHORIZED`
  - 操作员 A 被授权仓库 1，尝试查询仓库 2 的库存，预期返回空或 `403 FORBIDDEN`

#### 8.2.4 数据校验
- **测试点**：
  - 必填字段是否校验
  - 字段长度、格式是否校验
  - 业务规则是否校验（如 SKU 唯一性）
- **示例用例**：
  - 创建商品时不填写 SKU，预期返回 `422 VALIDATION_ERROR`
  - 创建商品时使用已存在的 SKU，预期返回 `409 SKU_DUPLICATED`
  - 入库数量为 0 或负数，预期返回校验错误

#### 8.2.5 前端交互规范
- **测试点**：
  - 表单提交时按钮是否禁用（防止重复提交）
  - 列表筛选条件改变后是否立即刷新
  - 编辑成功后列表是否显示最新数据
  - 删除成功后列表是否立即移除该记录
  - 中文输入过程中是否会误触发搜索
- **示例用例**：
  - 创建商品后，点击提交按钮，观察按钮是否变为禁用状态
  - 编辑商品名称后保存，返回列表页，检查商品名称是否更新
  - 在搜索框中输入中文，输入法还在编写状态时，不应触发搜索请求

#### 8.2.6 边界和异常场景
- **测试点**：
  - 分页参数越界（page < 1、page_size > 100）
  - 数据库中不存在的 ID
  - 并发操作
  - 大数据量性能
- **示例用例**：
  - 访问 `/api/products?page=0`，预期返回错误或默认为 page=1
  - 访问 `/api/products/99999`（不存在的 ID），预期返回 `404 NOT_FOUND`

---

## 9. 快速上手指南

### 9.1 启动系统
详见项目根目录的 `README.md` 文件。

### 9.2 测试账号
系统启动后会自动初始化测试账号（具体账号信息见项目文档）。

### 9.3 推荐测试顺序
1. **熟悉系统**：登录系统，浏览各个功能模块
2. **阅读 PRD**：仔细阅读 `docs/PRD.md`，理解需求
3. **编写用例**：根据 PRD 编写测试用例
4. **执行测试**：按功能模块逐一测试
5. **记录缺陷**：发现问题后，详细记录缺陷信息
6. **提交报告**：整理测试结果，提交缺陷报告

### 9.4 测试工具推荐
- **API 测试**：Postman、curl
- **浏览器开发者工具**：Chrome DevTools（查看网络请求、控制台日志）
- **数据库工具**：SQLite Browser（查看数据库数据）

---

## 10. 常见问题 FAQ

### Q1：为什么有些功能不符合 PRD？
A：如果发现系统实际行为与 PRD 不符，这是一个缺陷。请详细记录并报告这些问题。

### Q2：如何判断一个行为是 bug 还是功能？
A：以 PRD 为准。PRD 中明确说明的需求，如果系统实际行为不符合，就是 bug。

### Q3：测试时系统崩溃了怎么办？
A：这也是一个 bug！记录复现步骤，包括：操作流程、输入数据、错误信息、日志（如果有）。

### Q4：如何测试并发场景？
A：可以使用工具（如 JMeter、Postman 的 Runner）同时发送多个请求，观察系统行为。

### Q5：需要测试性能吗？
A：本系统主要关注功能正确性，性能测试不是重点，但如果发现明显的性能问题（如接口响应超过 10 秒），可以记录。

---

## 11. 总结

WMS（仓库管理系统）是企业物流管理的核心系统，涉及商品、库存、入库、出库等多个业务环节。作为测试人员，需要：

1. **理解业务**：掌握仓库管理的基本概念和流程
2. **关注规则**：重点测试状态机流转、库存一致性、权限控制等关键规则
3. **细心验证**：关注边界场景、异常场景、并发场景
4. **以 PRD 为准**：所有测试的判断标准都是产品需求文档

祝你在测试工作中学有所获，发现更多有价值的缺陷！

---

**文档版本**：v1.0  
**更新时间**：2026-01-02  
**维护人**：WMS 项目组
